name: 03 - SCA (Python Flask)

on:
  workflow_dispatch:
  workflow_call:

jobs:
  sca:
    name: SCA Python project
    runs-on: ubuntu-20.04

    defaults:
      run:
        shell: bash

    steps:
      # 1️⃣ Checkout
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2️⃣ Setup Python (requerido para CRDA + pip)
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # 3️⃣ Install dependencies (lock virtual env)
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # 4️⃣ Install CRDA (Red Hat Dependency Analytics)
      - name: Install SCA tool (CRDA)
        uses: redhat-actions/openshift-tools-installer@v1
        with:
          source: github
          github_pat: ${{ github.token }}
          crda: "latest"

      # 5️⃣ Run SCA scan (Python / pip)
      - name: Run SCA scan
        id: scan
        run: |
          crda analyze \
            --manifest requirements.txt \
            --json-output crda-report.json \
            --sarif-output crda-report.sarif

      # 6️⃣ Print JSON report
      - name: Print JSON analysis report
        if: always()
        run: cat crda-report.json

      # 7️⃣ Print SARIF report
      - name: Print SARIF analysis report
        if: always()
        run: cat crda-report.sarif

      # 8️⃣ Upload SARIF to GitHub Security tab
      - name: Upload SARIF to GitHub
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: crda-report.sarif
